<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story 9.6: Scrolling Test</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="custom_components/beatsy/www/css/custom.css">
    <style>
        /* Inline version of Story 9.6 CSS for testing */
        #round-results-list {
            -webkit-overflow-scrolling: touch;
            transform: translateZ(0);
            will-change: scroll-position;
        }
    </style>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-md mx-auto">
        <h1 class="text-2xl font-bold mb-4">Story 9.6: Responsive Scrolling Test</h1>

        <div class="mb-4 p-3 bg-blue-100 rounded">
            <h2 class="font-semibold mb-2">Test Scenarios:</h2>
            <button onclick="render3Players()" class="bg-blue-600 text-white px-3 py-2 rounded mr-2 mb-2">3 Players (No Scroll)</button>
            <button onclick="render10Players()" class="bg-blue-600 text-white px-3 py-2 rounded mr-2 mb-2">10 Players (Scrollable)</button>
            <button onclick="render20Players()" class="bg-blue-600 text-white px-3 py-2 rounded mr-2 mb-2">20 Players (Long Scroll)</button>
            <button onclick="testScrollReset()" class="bg-green-600 text-white px-3 py-2 rounded mr-2 mb-2">Test Scroll Reset</button>
        </div>

        <!-- Results View Structure (matching start.html) -->
        <div id="results-view" class="min-h-screen bg-gradient-to-b from-green-50 to-green-100 p-4">
            <div class="max-w-md mx-auto mt-8">
                <!-- Correct Year Section (NOT scrollable) -->
                <div id="correct-year-section" class="text-center mb-6">
                    <h2 class="text-xl font-semibold text-gray-700 mb-3">The Correct Year</h2>
                    <div id="correct-year" class="text-6xl font-bold text-green-600 mb-2">1985</div>
                </div>

                <!-- Round Results Board (SCROLLABLE) -->
                <div id="round-results-section" class="bg-white rounded-lg shadow-md p-3 mb-4">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Round Results</h3>
                    <div id="round-results-list" class="space-y-2 max-h-80 overflow-y-auto" tabindex="0" role="region" aria-label="Round results list">
                        <!-- Results items will be inserted here by JavaScript -->
                    </div>
                </div>

                <!-- Leaderboard Section (NOT scrollable) -->
                <div id="leaderboard-section" class="bg-white rounded-lg shadow-md p-3 mb-4">
                    <h3 class="text-xl font-semibold text-gray-700 mb-3">Leaderboard</h3>
                    <div id="leaderboard-list" class="space-y-2">
                        <div class="p-2 bg-gray-50">Top 5 players shown here</div>
                    </div>
                </div>

                <!-- Waiting State (NOT scrollable) -->
                <div id="waiting-state" role="status" aria-live="polite" class="text-center mt-8">
                    <p class="text-lg text-gray-600">Waiting for next song...</p>
                </div>
            </div>
        </div>

        <!-- Test Results Panel -->
        <div id="test-results" class="mt-4 p-3 bg-yellow-100 rounded">
            <h3 class="font-semibold mb-2">Test Results:</h3>
            <div id="test-output" class="text-sm font-mono"></div>
        </div>
    </div>

    <script>
        function renderResults(count, testName) {
            const listEl = document.getElementById('round-results-list');
            const results = [];

            // Generate mock player results
            for (let i = 0; i < count; i++) {
                results.push({
                    player_name: `Player${i + 1}`,
                    guess: 1980 + i,
                    points_earned: Math.max(0, 10 - i),
                    bet_placed: i % 3 === 0,
                    new_score: 50 - i
                });
            }

            // Render HTML (simplified version of ui-results.js)
            const html = results.map(r => {
                const bgClass = 'bg-white';
                const pointsClass = r.points_earned > 0 ? 'text-green-600' : 'text-gray-400';
                const pointsPrefix = r.points_earned > 0 ? '+' : '';
                const betIndicator = r.bet_placed ? '<span class="text-xl ml-1">üî•</span>' : '';

                return `
                    <div class="result-row ${bgClass} p-3 border-b border-gray-200 flex justify-between items-center">
                        <div class="flex items-center gap-2">
                            <span class="font-semibold">${r.player_name}</span>
                            ${betIndicator}
                            <span class="text-gray-600 text-sm">guessed ${r.guess}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold ${pointsClass}">
                                ${pointsPrefix}${r.points_earned}
                            </span>
                        </div>
                    </div>
                `;
            }).join('');

            listEl.innerHTML = html;

            // Story 9.6: Reset scroll position to top
            listEl.scrollTop = 0;

            runTests(count, testName);
        }

        function runTests(playerCount, testName) {
            const listEl = document.getElementById('round-results-list');
            const yearEl = document.getElementById('correct-year-section');
            const leaderboardEl = document.getElementById('leaderboard-section');
            const output = [];

            output.push(`<div class="font-bold mb-2">${testName}</div>`);
            output.push(`Players rendered: ${playerCount} ‚úì`);

            // Test 1: Scrollable container has correct classes
            const hasOverflow = listEl.classList.contains('overflow-y-auto');
            const hasMaxHeight = listEl.classList.contains('max-h-80');
            output.push(`Overflow classes: ${hasOverflow && hasMaxHeight ? '‚úì' : '‚úó FAIL'}`);

            // Test 2: Check if scrolling is needed
            const needsScroll = listEl.scrollHeight > listEl.clientHeight;
            const expectedScroll = playerCount > 5;
            output.push(`Scrolling ${needsScroll ? 'enabled' : 'disabled'}: ${needsScroll === expectedScroll ? '‚úì' : '‚úó FAIL'}`);

            // Test 3: Scroll position is at top
            const scrollAtTop = listEl.scrollTop === 0;
            output.push(`Scroll position reset: ${scrollAtTop ? '‚úì' : '‚úó FAIL'}`);

            // Test 4: Year section is visible (not inside scrollable container)
            const yearVisible = !listEl.contains(yearEl);
            output.push(`Year section outside scroll: ${yearVisible ? '‚úì' : '‚úó FAIL'}`);

            // Test 5: Leaderboard is visible (not inside scrollable container)
            const leaderboardVisible = !listEl.contains(leaderboardEl);
            output.push(`Leaderboard outside scroll: ${leaderboardVisible ? '‚úì' : '‚úó FAIL'}`);

            // Test 6: Keyboard accessibility
            const hasTabIndex = listEl.hasAttribute('tabindex');
            const hasAriaLabel = listEl.hasAttribute('aria-label');
            const hasRole = listEl.getAttribute('role') === 'region';
            output.push(`Keyboard accessible: ${hasTabIndex && hasAriaLabel && hasRole ? '‚úì' : '‚úó FAIL'}`);

            // Test 7: iOS/GPU optimizations (CSS check)
            const styles = window.getComputedStyle(listEl);
            const hasTransform = styles.transform !== 'none';
            const hasWillChange = styles.willChange.includes('scroll');
            output.push(`GPU acceleration: ${hasTransform ? '‚úì' : '‚úó FAIL'}`);
            output.push(`Will-change hint: ${hasWillChange ? '‚úì' : '‚ö†Ô∏è May not be detected in test'}`);

            document.getElementById('test-output').innerHTML = output.join('<br>');
        }

        function render3Players() {
            renderResults(3, 'Test 1: 3 Players (No Scroll Expected)');
        }

        function render10Players() {
            renderResults(10, 'Test 2: 10 Players (Scrolling Expected)');
        }

        function render20Players() {
            renderResults(20, 'Test 3: 20 Players (Long Scrolling)');
        }

        function testScrollReset() {
            const listEl = document.getElementById('round-results-list');

            // First render 20 players
            renderResults(20, 'Test 4: Scroll Reset');

            // Wait a bit, then scroll to middle
            setTimeout(() => {
                listEl.scrollTop = 200;

                setTimeout(() => {
                    const beforeReset = listEl.scrollTop;

                    // Render again (should reset scroll)
                    renderResults(20, 'Test 4: Scroll Reset (After Re-render)');

                    const afterReset = listEl.scrollTop;
                    const output = document.getElementById('test-output');
                    output.innerHTML += `<br><br><strong>Scroll Reset Test:</strong><br>Before: ${beforeReset}px<br>After: ${afterReset}px<br>Result: ${afterReset === 0 ? '‚úì PASS' : '‚úó FAIL'}`;
                }, 500);
            }, 500);
        }

        // Auto-run first test on load
        window.addEventListener('load', () => {
            render3Players();
        });
    </script>
</body>
</html>
