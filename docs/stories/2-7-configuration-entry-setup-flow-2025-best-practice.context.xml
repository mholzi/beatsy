<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>7</storyId>
    <title>Configuration Entry Setup Flow (2025 Best Practice)</title>
    <status>drafted</status>
    <generatedAt>2025-11-13</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-7-configuration-entry-setup-flow-2025-best-practice.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Home Assistant user</asA>
    <iWant>a configuration UI in HA to set up Beatsy</iWant>
    <soThat>I can configure basic settings through HA's integrations page following 2025 best practices</soThat>
    <tasks>
      <!-- Tasks extracted from story file -->
      <task id="1" ac="1,2">Create config_flow.py Module</task>
      <task id="2" ac="2,3">Define Configuration Schema</task>
      <task id="3" ac="2,3,4">Implement User Step</task>
      <task id="4" ac="5">Update __init__.py for Config Entry Pattern</task>
      <task id="5" ac="6">Implement Options Flow</task>
      <task id="6" ac="6">Implement Entry Reload on Options Change</task>
      <task id="7" ac="7">Implement Unload Entry</task>
      <task id="8" ac="1">Update manifest.json</task>
      <task id="9" ac="2,3">Create Translation Strings</task>
      <task id="10" ac="8" optional="true">Backward Compatibility Support</task>
      <task id="11" ac="2,3,4">Unit Tests - Config Flow</task>
      <task id="12" ac="6">Unit Tests - Options Flow</task>
      <task id="13" ac="1,4,5">Integration Test - Full Setup Flow</task>
      <task id="14" ac="7">Integration Test - Unload Flow</task>
      <task id="15" ac="1,2,6" type="manual">Manual Testing - HA UI Flow</task>
      <task id="16" ac="3" type="manual">Manual Testing - Validation</task>
      <task id="17" ac="1,8">Documentation Updates</task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <ac id="1" title="Integration Discovery and Installation">
      <given>Beatsy is installed via HACS</given>
      <when>I navigate to Settings → Integrations → Add Integration → Beatsy</when>
      <then>
        - Beatsy appears in the integration list
        - Clicking on it launches the config flow UI
        - manifest.json includes "config_flow": true
        - Integration is discoverable via HA's integration registry
      </then>
    </ac>

    <ac id="2" title="User Configuration Step">
      <given>I've selected Beatsy from Add Integration</given>
      <when>The configuration dialog appears</when>
      <then>
        - I see a form with the following optional fields:
          • Timer duration (number input, 10-120 seconds, default: 30)
          • Year range minimum (number input, 1900-2024, default: 1950)
          • Year range maximum (number input, 1900-2024, default: 2024)
        - All fields show helpful descriptions/tooltips
        - All fields have sensible defaults pre-filled
        - Form validates inputs before submission
      </then>
    </ac>

    <ac id="3" title="Input Validation">
      <given>I'm entering configuration values</given>
      <when>I submit the form</when>
      <then>
        - The following validations are enforced:
          • Timer duration: Must be integer between 10-120 seconds
          • Year range min: Must be integer between 1900-2024
          • Year range max: Must be integer between 1900-2024
          • Year range: min must be less than max
        - Validation errors are displayed clearly with specific messages
        - Invalid form cannot be submitted
      </then>
    </ac>

    <ac id="4" title="Configuration Entry Creation">
      <given>I've submitted valid configuration</given>
      <when>The config flow completes</when>
      <then>
        - A ConfigEntry is created in HA's config storage
        - Entry includes:
          • entry_id: Unique UUID
          • domain: "beatsy"
          • data: User-configured values (timer_duration, year_range_min, year_range_max)
          • options: Empty dict (for future use)
          • title: "Beatsy"
        - Entry is persisted to .storage/core.config_entries
        - Integration appears in HA's Integrations list with "Configure" button
      </then>
    </ac>

    <ac id="5" title="Component Setup via Config Entry">
      <given>ConfigEntry has been created</given>
      <when>HA loads the integration</when>
      <then>
        - async_setup_entry(hass, entry) is called instead of legacy async_setup()
        - Component initializes successfully using entry data
        - Configured values are applied to default game config
        - Component logs "Beatsy integration loaded from config entry"
        - All core functionality works identically to legacy setup
      </then>
    </ac>

    <ac id="6" title="Reconfigure/Options Flow">
      <given>Integration is installed with config entry</given>
      <when>I click "Configure" button on the Beatsy integration</when>
      <then>
        - An options flow dialog appears
        - Dialog shows current configuration values
        - I can update timer duration and year ranges
        - Updated values are saved to entry.options
        - Integration reloads with new configuration
      </then>
    </ac>

    <ac id="7" title="Integration Unload">
      <given>Integration is loaded via config entry</given>
      <when>I remove the integration from HA</when>
      <then>
        - async_unload_entry(hass, entry) is called
        - All resources are cleaned up (WebSocket connections, timers, state)
        - ConfigEntry is removed from HA's storage
        - No errors appear in HA logs
      </then>
    </ac>

    <ac id="8" title="Backward Compatibility (Optional)">
      <given>Some users may have legacy YAML config</given>
      <when>HA loads Beatsy</when>
      <then>
        - Integration detects if ConfigEntry exists
        - If no ConfigEntry: Falls back to legacy async_setup() with defaults
        - If ConfigEntry exists: Uses modern async_setup_entry()
        - Logs indicate which setup method was used
      </then>
    </ac>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <!-- Primary Technical Specification -->
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Technical Specification - Epic 2</title>
        <section>Story 2.7: Configuration Entry Setup</section>
        <snippet>Implements modern HA 2025 config entry pattern with ConfigFlow class, async_setup_entry(), and UI-based configuration. Provides timer duration and year range settings.</snippet>
        <relevance>Primary technical spec for this story - defines ConfigEntry data structure, Configuration Flow API, and acceptance criteria</relevance>
      </doc>

      <!-- Epic and Story Definitions -->
      <doc>
        <path>docs/epics.md</path>
        <title>Epic Breakdown and Stories</title>
        <section>Story 2.7: Configuration Entry Setup Flow (2025 Best Practice)</section>
        <snippet>Modern config flow pattern using async_setup_entry() + ConfigFlow. Create config_flow.py with ConfigFlow class, implement user/options steps, register in manifest.json with "config_flow": true.</snippet>
        <relevance>Defines story requirements, modern HA 2025 patterns, and implementation approach</relevance>
      </doc>

      <!-- System Architecture -->
      <doc>
        <path>docs/architecture.md</path>
        <title>System Architecture</title>
        <section>Repository Structure</section>
        <snippet>Component structure includes __init__.py for integration setup, manifest.json for HA metadata, and config_flow.py (optional) for HA UI config.</snippet>
        <relevance>Defines file locations and component responsibilities for config entry implementation</relevance>
      </doc>

      <!-- Related Story Context -->
      <doc>
        <path>docs/stories/2-6-websocket-command-registration.md</path>
        <title>Story 2.6: WebSocket Command Registration</title>
        <section>Integration Points</section>
        <snippet>WebSocket commands and HTTP routes registered during component setup. Story 2.7 must call these registration functions from async_setup_entry() instead of async_setup().</snippet>
        <relevance>Defines integration points - config entry setup must register WebSocket/HTTP infrastructure</relevance>
      </doc>

      <!-- Home Assistant Best Practices -->
      <doc>
        <path>External Reference</path>
        <title>HA Config Flow Documentation</title>
        <section>Config Entries Best Practices</section>
        <snippet>Use ConfigFlow for setup UI, implement async_step_user() for initial config, OptionsFlow for reconfiguration, async_setup_entry() for entry-based setup, async_unload_entry() for cleanup.</snippet>
        <relevance>Official HA patterns for config entry implementation</relevance>
      </doc>
    </docs>
    <code>
      <!-- Core Integration Files (EXISTING - Story 2.7 appears implemented) -->
      <artifact>
        <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
        <kind>integration_setup</kind>
        <symbol>async_setup_entry</symbol>
        <lines>45</lines>
        <reason>Entry-based setup function - Story 2.7 target function. Already implemented.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
        <kind>integration_setup</kind>
        <symbol>async_unload_entry</symbol>
        <lines>205</lines>
        <reason>Entry unload function for cleanup - Story 2.7 AC-7. Already implemented.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
        <kind>integration_setup</kind>
        <symbol>async_reload_entry</symbol>
        <lines>249</lines>
        <reason>Entry reload function for config changes - Story 2.7 AC-6. Already implemented.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/config_flow.py</path>
        <kind>config_flow</kind>
        <symbol>BeatsyConfigFlow</symbol>
        <lines>12</lines>
        <reason>ConfigFlow class for UI-based setup - Story 2.7 primary deliverable. Already exists.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/manifest.json</path>
        <kind>metadata</kind>
        <symbol>config_flow: true</symbol>
        <lines>5</lines>
        <reason>Enables config flow in HA - Story 2.7 AC-1. Already configured.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/const.py</path>
        <kind>constants</kind>
        <symbol>DOMAIN</symbol>
        <lines>1-10</lines>
        <reason>Domain constant and default config values - referenced by config flow.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/game_state.py</path>
        <kind>state_management</kind>
        <symbol>init_game_state, get_game_state, update_game_config</symbol>
        <lines>112, 134, 217</lines>
        <reason>State initialization functions - must accept config from entry data (Story 2.7 AC-5).</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/websocket_api.py</path>
        <kind>websocket_handlers</kind>
        <symbol>handle_join_game, handle_submit_guess, etc.</symbol>
        <lines>101-429</lines>
        <reason>WebSocket command handlers - must be registered from async_setup_entry (Story 2.6/2.7 integration).</reason>
      </artifact>

      <!-- Test Files (Expected locations) -->
      <artifact>
        <path>tests/test_config_flow.py</path>
        <kind>test</kind>
        <symbol>Expected test file</symbol>
        <lines>N/A</lines>
        <reason>Unit tests for config flow - Story 2.7 Task 11.</reason>
      </artifact>

      <artifact>
        <path>tests/test_integration_lifecycle.py</path>
        <kind>test</kind>
        <symbol>Expected test file</symbol>
        <lines>N/A</lines>
        <reason>Integration tests for setup/unload flows - Story 2.7 Tasks 13-14.</reason>
      </artifact>
    </code>

    <dependencies>
      <!-- Python/Home Assistant -->
      <ecosystem name="homeassistant">
        <package>homeassistant.config_entries</package>
        <package>homeassistant.core (HomeAssistant, callback)</package>
        <package>homeassistant.helpers.storage</package>
        <package>voluptuous (validation)</package>
      </ecosystem>

      <!-- Testing -->
      <ecosystem name="python-testing">
        <package>pytest</package>
        <package>pytest-asyncio</package>
        <package>pytest-homeassistant-custom-component</package>
      </ecosystem>
    </dependencies>
  </artifacts>

  <constraints>
    <!-- Development Constraints from Dev Notes -->
    <constraint>Use modern HA 2025 config entry pattern - async_setup_entry() NOT legacy async_setup()</constraint>
    <constraint>Store config in .storage/core.config_entries (HA managed) - NOT custom files</constraint>
    <constraint>Initialize game state with entry data: init_game_state(hass, entry_id, config_from_entry)</constraint>
    <constraint>Register WebSocket commands and HTTP routes from async_setup_entry()</constraint>
    <constraint>Implement OptionsFlow for reconfiguration - use entry.options for updated values</constraint>
    <constraint>Reload integration automatically on config change via entry.add_update_listener()</constraint>
    <constraint>Clean up all resources in async_unload_entry(): WebSocket connections, timers, state</constraint>
    <constraint>Validate year range consistency: min must be less than max</constraint>
    <constraint>Provide translations in translations/en.json for all UI text</constraint>
    <constraint>Optional backward compatibility: Keep legacy async_setup() as fallback</constraint>
  </constraints>

  <interfaces>
    <!-- Home Assistant APIs -->
    <interface>
      <name>ConfigFlow</name>
      <kind>HA Config Entry API</kind>
      <signature>class BeatsyConfigFlow(config_entries.ConfigFlow, domain=DOMAIN)</signature>
      <path>homeassistant.config_entries</path>
      <methods>
        - async_step_user(user_input): Initial setup step
        - async_step_import(import_config): Import from YAML (optional)
        - async_create_entry(title, data): Create ConfigEntry
      </methods>
    </interface>

    <interface>
      <name>OptionsFlow</name>
      <kind>HA Config Entry API</kind>
      <signature>class BeatsyOptionsFlow(config_entries.OptionsFlow)</signature>
      <path>homeassistant.config_entries</path>
      <methods>
        - async_step_init(user_input): Options configuration step
        - async_create_entry(data): Update entry.options
      </methods>
    </interface>

    <interface>
      <name>Entry-based Setup</name>
      <kind>HA Integration Lifecycle</kind>
      <signature>async def async_setup_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool</signature>
      <path>custom_components/beatsy/__init__.py</path>
      <details>Replaces legacy async_setup(). Called when ConfigEntry is loaded.</details>
    </interface>

    <interface>
      <name>Entry Unload</name>
      <kind>HA Integration Lifecycle</kind>
      <signature>async def async_unload_entry(hass: HomeAssistant, entry: ConfigEntry) -> bool</signature>
      <path>custom_components/beatsy/__init__.py</path>
      <details>Cleanup when integration is removed. Must close WebSocket connections, clear state.</details>
    </interface>

    <interface>
      <name>Entry Reload</name>
      <kind>HA Integration Lifecycle</kind>
      <signature>async def async_reload_entry(hass: HomeAssistant, entry: ConfigEntry) -> None</signature>
      <path>custom_components/beatsy/__init__.py</path>
      <details>Called when options are updated. Reload integration with new config.</details>
    </interface>

    <interface>
      <name>Game State Initialization</name>
      <kind>Internal API</kind>
      <signature>def init_game_state(hass: HomeAssistant, entry_id: str, config: dict = None) -> BeatsyGameState</signature>
      <path>custom_components/beatsy/game_state.py</path>
      <details>Initialize game state with config from entry data. Accepts timer_duration, year_range_min, year_range_max.</details>
    </interface>
  </interfaces>
  <tests>
    <standards>
Testing framework: pytest + pytest-asyncio + pytest-homeassistant-custom-component

Unit Test Standards:
- Test each config flow step independently
- Mock HA components (config_entries, storage, hass)
- Test schema validation (voluptuous schemas)
- Test error conditions and edge cases
- Achieve >80% code coverage

Integration Test Standards:
- Test full config entry lifecycle (setup → reload → unload)
- Test with real HA test instance (hass fixture)
- Use MockConfigEntry for config entry testing
- Verify state changes and resource cleanup
- Test integration with WebSocket/HTTP registration

Manual Test Standards (from story):
- Test via HA UI (Settings → Integrations → Add Integration)
- Verify form validation with invalid inputs
- Test options flow (Configure button)
- Verify integration reload on config change
- Check HA logs for expected messages
    </standards>

    <locations>
      <!-- Unit Tests -->
      <location>tests/test_config_flow.py</location>
      <location>tests/test_integration_lifecycle.py</location>

      <!-- Integration Tests -->
      <location>tests/test_init.py</location>

      <!-- Test Configuration -->
      <location>tests/conftest.py</location>
    </locations>

    <ideas>
      <!-- Unit Tests - Config Flow -->
      <test ac="1,2">Test config flow user step displays form with correct schema</test>
      <test ac="2,4">Test valid input creates config entry successfully</test>
      <test ac="3">Test invalid timer duration shows validation error</test>
      <test ac="3">Test year range min >= max shows validation error</test>
      <test ac="4">Test config entry data stored correctly with all fields</test>

      <!-- Unit Tests - Options Flow -->
      <test ac="6">Test options flow displays current configuration values</test>
      <test ac="6">Test valid options update saved successfully to entry.options</test>
      <test ac="6">Test invalid options show validation errors</test>
      <test ac="6">Test entry reload triggered on options change</test>

      <!-- Integration Tests - Setup Flow -->
      <test ac="1,4,5">Test load Beatsy in HA test instance via config entry</test>
      <test ac="5">Test async_setup_entry() called correctly with entry parameter</test>
      <test ac="5">Test integration initializes game state with entry data</test>
      <test ac="5">Test WebSocket commands registered during setup</test>
      <test ac="5">Test HTTP routes registered during setup</test>
      <test ac="1">Test integration appears in HA integrations list</test>
      <test ac="5">Test all core functionality works after setup</test>

      <!-- Integration Tests - Unload Flow -->
      <test ac="7">Test remove integration via HA unload mechanism</test>
      <test ac="7">Test async_unload_entry() called successfully</test>
      <test ac="7">Test all resources cleaned up (WebSocket, state)</test>
      <test ac="7">Test no errors in logs after unload</test>
      <test ac="7">Test can re-add integration after unload</test>

      <!-- Integration Tests - Config Changes -->
      <test ac="6">Test update timer duration via options flow</test>
      <test ac="6">Test integration reloads with new config values</test>
      <test ac="6">Test game state updated with new config</test>

      <!-- Manual Tests (from story Tasks 15-16) -->
      <test ac="1,2" type="manual">Navigate HA UI to Add Integration and select Beatsy</test>
      <test ac="2,3" type="manual">Fill in config form and test validation with invalid values</test>
      <test ac="6" type="manual">Click Configure button and update settings</test>
      <test ac="7" type="manual">Remove integration and verify cleanup</test>

      <!-- Backward Compatibility Tests (Optional) -->
      <test ac="8" optional="true">Test legacy async_setup() fallback if no config entry</test>
      <test ac="8" optional="true">Test config entry takes precedence over legacy setup</test>
    </ideas>
  </tests>
</story-context>
