<story-context id="2-4-spotify-media-player-detection" v="1.0">
  <metadata>
    <epicId>2</epicId>
    <storyId>2.4</storyId>
    <title>Spotify Media Player Detection</title>
    <status>drafted</status>
    <generatedAt>2025-11-12</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/2-4-spotify-media-player-detection.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Beatsy admin</asA>
    <iWant>to see a list of available media players that can play Spotify tracks</iWant>
    <soThat>I can select which device plays the music during the game</soThat>
    <tasks>
      - Task 1: Create Spotify Helper Module Structure (MediaPlayerInfo dataclass)
      - Task 2: Implement Media Player Detection Logic (get_spotify_media_players function)
      - Task 3: Service Capability Detection (_supports_spotify_playback helper)
      - Task 4: Empty List and Warning Handling
      - Task 5: Error Handling and Edge Cases
      - Task 6: Integration with Component Init
      - Task 7-10: Unit Tests (detection, data structure, empty list, error handling)
      - Task 11: Integration Test - Real HA State
      - Task 12-13: Manual Testing (Cast device detection, player list validation)
      - Task 14: Documentation - Cast Device Support
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1" priority="high">
      <title>Media Player Detection</title>
      <given>Home Assistant has media player entities configured</given>
      <when>get_spotify_media_players() is called</when>
      <then>function returns list of media players capable of playing Spotify URIs</then>
      <and>each player includes: entity_id, friendly_name, current state</and>
      <and>function filters for players that support media_player.play_media service</and>
      <and>function completes within 100ms</and>
    </criterion>

    <criterion id="AC-2" priority="critical">
      <title>Cast-Enabled Device Detection</title>
      <given>user has Cast-enabled devices (Chromecast, Google Home, Sonos, etc.)</given>
      <when>detecting media players</when>
      <then>Cast devices are included in the returned list</then>
      <and>Cast devices do NOT require Spotify integration to be loaded</and>
      <and>devices are identified by media_content_type support for "music" or "spotify"</and>
      <note>CRITICAL: Story 1.4 POC validated Cast devices play spotify:track URIs WITHOUT Spotify integration</note>
    </criterion>

    <criterion id="AC-3" priority="high">
      <title>Empty List Handling</title>
      <given>no compatible media players exist in HA</given>
      <when>get_spotify_media_players() is called</when>
      <then>function returns empty list</then>
      <and>WARNING log message: "No Spotify-capable media players found"</and>
      <and>function does NOT raise exceptions</and>
    </criterion>

    <criterion id="AC-4" priority="high">
      <title>Player Information Structure</title>
      <given>media players are detected</given>
      <when>player information is returned</when>
      <then>each player has MediaPlayerInfo dataclass structure</then>
      <and>structure uses Python 3.14+ type hints</and>
      <structure>
        @dataclass
        class MediaPlayerInfo:
            entity_id: str          # "media_player.living_room_speaker"
            friendly_name: str      # "Living Room Speaker"
            state: str             # "idle" | "playing" | "paused" | "off"
            supports_play_media: bool  # True if supports play_media service
      </structure>
    </criterion>

    <criterion id="AC-5" priority="medium">
      <title>Admin UI Integration Ready</title>
      <given>get_spotify_media_players() returns player list</given>
      <when>admin UI (Epic 3) calls this function</when>
      <then>returned data is suitable for populating a dropdown selector</then>
      <and>friendly_name values are human-readable</and>
      <and>entity_id values are valid for media_player.play_media service calls</and>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-2.md</path>
        <title>Epic 2 Technical Specification</title>
        <section>Story 2.4: Spotify Media Player Detection</section>
        <snippet>Detect all Spotify-capable media players in the HA instance. Function queries hass.states.async_all("media_player") and filters entities with Spotify capability. Returns List of SpotifyMediaPlayer objects with entity_id and friendly_name. Handles case where no players exist (returns empty list with warning).</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>Beatsy Architecture</title>
        <section>Pattern 4: Minimal JSON + Runtime Metadata</section>
        <snippet>Cast devices can play spotify:track URIs directly without Spotify integration. Metadata (title, artist, album art) automatically populated in media player state after playback starts. This pattern eliminates need for Spotify integration dependency.</snippet>
      </doc>

      <doc>
        <path>docs/stories/1-4-spotify-api-basic-integration-test.md</path>
        <title>Story 1.4 POC Validation</title>
        <section>Completion Notes</section>
        <snippet>POC validated: Cast devices (Chromecast, Google Home, Sonos) play Spotify URIs WITHOUT requiring Spotify integration to be loaded. Metadata appears in media player state attributes after 2-second delay. Album art included via entity_picture attribute.</snippet>
      </doc>

      <doc>
        <path>docs/stories/2-3-in-memory-game-state-management.md</path>
        <title>Story 2.3 State Management</title>
        <section>State Structure</section>
        <snippet>BeatsyGameState dataclass includes game_config field with media_player_entity_id: str. Story 2.4 provides list of media players to populate admin dropdown. Selected entity_id stored in game_config for Epic 7 playback.</snippet>
      </doc>
    </docs>

    <code>
      <artifact>
        <path>home-assistant-config/custom_components/beatsy/spotify_helper.py</path>
        <kind>module</kind>
        <symbol>fetch_playlist_tracks, extract_track_metadata, play_track</symbol>
        <lines>1-295</lines>
        <reason>Existing Spotify helper from Story 1.4. Contains playlist fetching and playback functions. Story 2.4 adds get_spotify_media_players() function to this module.</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
        <kind>component-init</kind>
        <symbol>async_setup_entry</symbol>
        <lines>29-75</lines>
        <reason>Component initialization. Story 2.4 imports get_spotify_media_players and calls it during setup to validate media player availability. Stores function reference in hass.data[DOMAIN].</reason>
      </artifact>

      <artifact>
        <path>home-assistant-config/custom_components/beatsy/const.py</path>
        <kind>constants</kind>
        <symbol>DOMAIN</symbol>
        <lines>1-10</lines>
        <reason>Domain constant used for hass.data storage key. Required for storing spotify_helper function references.</reason>
      </artifact>
    </code>

    <dependencies>
      <python>
        <package name="homeassistant.core" version="2024.1+">Required: HomeAssistant, State</package>
        <package name="homeassistant.const" version="2024.1+">Required: SUPPORT_PLAY_MEDIA constant</package>
        <package name="dataclasses" version="stdlib">Required: dataclass decorator</package>
        <package name="typing" version="stdlib">Required: List, Optional type hints</package>
        <package name="logging" version="stdlib">Required: _LOGGER</package>
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <rule>NO Spotify integration dependency - Cast devices play Spotify URIs natively</rule>
      <rationale>Story 1.4 POC validated Cast devices work without Spotify integration loaded</rationale>
    </constraint>

    <constraint type="architecture">
      <rule>Use Python 3.14+ type hints (list[Type] not List[Type])</rule>
      <rationale>Consistent with Story 2.3 state management patterns</rationale>
    </constraint>

    <constraint type="performance">
      <rule>Detection must complete within 100ms</rule>
      <rationale>In-memory state query, no external API calls</rationale>
    </constraint>

    <constraint type="error-handling">
      <rule>Never raise exceptions - return empty list on error</rule>
      <rationale>Graceful degradation, log warnings, don't crash component</rationale>
    </constraint>

    <constraint type="modularity">
      <rule>Add get_spotify_media_players() to existing spotify_helper.py module</rule>
      <rationale>Logical grouping with other Spotify-related functions from Story 1.4</rationale>
    </constraint>

    <constraint type="testing">
      <rule>Unit tests must achieve >80% coverage</rule>
      <rationale>Epic 2 standard for all core infrastructure functions</rationale>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>get_spotify_media_players</name>
      <kind>async function</kind>
      <signature>async def get_spotify_media_players(hass: HomeAssistant) -> list[MediaPlayerInfo]</signature>
      <path>home-assistant-config/custom_components/beatsy/spotify_helper.py</path>
      <description>Main detection function - queries all media_player entities and filters for Spotify-capable devices</description>
    </interface>

    <interface>
      <name>_supports_spotify_playback</name>
      <kind>helper function</kind>
      <signature>def _supports_spotify_playback(state: State) -> bool</signature>
      <path>home-assistant-config/custom_components/beatsy/spotify_helper.py</path>
      <description>Checks if media player supports Spotify URI playback - detects Cast devices or SUPPORT_PLAY_MEDIA feature</description>
    </interface>

    <interface>
      <name>MediaPlayerInfo</name>
      <kind>dataclass</kind>
      <signature>@dataclass class MediaPlayerInfo: entity_id, friendly_name, state, supports_play_media</signature>
      <path>home-assistant-config/custom_components/beatsy/spotify_helper.py</path>
      <description>Type-safe player data structure for admin dropdown</description>
    </interface>

    <interface>
      <name>hass.states.async_all</name>
      <kind>HA core API</kind>
      <signature>async_all(domain: str) -> list[State]</signature>
      <path>homeassistant.core</path>
      <description>Query all entities in a domain - used to fetch all media_player entities</description>
    </interface>

    <interface>
      <name>hass.data[DOMAIN]["spotify_helper"]</name>
      <kind>state storage</kind>
      <signature>{"get_media_players": Callable}</signature>
      <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
      <description>Component stores function reference for Epic 3 admin UI to call</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Story 2.4 follows pytest + pytest-asyncio testing standards established in Story 1.4 and Story 2.3.
      All async functions tested with async def test_* pattern. Mock hass instance using pytest-homeassistant-custom-component fixtures.
      Target >80% code coverage. Tests verify: basic detection, Cast device detection, empty list handling, error handling, data structure correctness.
    </standards>

    <locations>
      <location>tests/test_spotify_helper.py</location>
      <pattern>tests/test_*.py</pattern>
    </locations>

    <ideas>
      <test id="T1" ac="AC-1">
        Test basic detection: Mock hass.states with Cast device entity, verify get_spotify_media_players() returns MediaPlayerInfo with correct fields
      </test>

      <test id="T2" ac="AC-2">
        Test Cast device detection: Entity ID contains "cast" or "chromecast" → detected. Entity has SUPPORT_PLAY_MEDIA feature → detected
      </test>

      <test id="T3" ac="AC-3">
        Test empty list handling: Mock empty states → returns [], logs WARNING. Mock unavailable players → returns [], filters correctly
      </test>

      <test id="T4" ac="AC-4">
        Test data structure: Verify MediaPlayerInfo dataclass fields using typing.get_type_hints(). Test friendly_name fallback to entity_id when attribute missing
      </test>

      <test id="T5" ac="AC-3">
        Test error handling: Mock hass.states.async_all() to raise exception → returns [], logs ERROR. Test None attributes handled gracefully
      </test>

      <test id="T6" ac="AC-5">
        Integration test: Add 3 mock media players to hass.states, call function, verify correct count and data. Verify JSON-serializable for API
      </test>

      <test id="T7" ac="AC-1">
        Performance test: Verify detection completes within 100ms using pytest-benchmark
      </test>
    </ideas>
  </tests>
</story-context>
