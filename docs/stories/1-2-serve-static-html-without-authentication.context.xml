<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.2</storyId>
    <title>Serve Static HTML Without Authentication</title>
    <status>drafted</status>
    <generatedAt>2025-11-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-2-serve-static-html-without-authentication.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>party guest (player)</asA>
    <iWant>to access a test HTML page without logging into Home Assistant</iWant>
    <soThat>I can join games with zero friction</soThat>
    <tasks>
      - Task 1: Research Unauthenticated HTTP Patterns in HA (AC: #1)
        - Research `homeassistant.components.http.HomeAssistantView` class
        - Investigate `requires_auth` parameter or decorator patterns
        - Review HA documentation on public routes (2025 standards)
        - Document exact pattern for bypassing authentication

      - Task 2: Create Static HTML Test Page (AC: #2)
        - Create `custom_components/beatsy/www/` directory
        - Create `test.html` with basic HTML structure
        - Add heading: "Beatsy POC - Unauthenticated Access Test"
        - Add visual confirmation elements (timestamp, device info)
        - Add metadata and DOCTYPE declaration
        - Validate HTML structure

      - Task 3: Implement HTTP View Handler (AC: #1, #4)
        - Create `custom_components/beatsy/http_view.py` module
        - Import necessary HA HTTP modules (`HomeAssistantView` or alternatives)
        - Implement view class with `requires_auth=False` or equivalent
        - Define route: `/api/beatsy/test.html`
        - Implement GET handler to serve `test.html` content
        - Add proper HTTP headers (Content-Type: text/html)
        - Add INFO log: "Test HTTP view registered at /api/beatsy/test.html"

      - Task 4: Register HTTP View in Component Initialization (AC: #4)
        - Update `__init__.py` to import `http_view` module
        - Add HTTP view registration in `async_setup()` function
        - Use `hass.http` API to register the view
        - Ensure registration happens after component data initialization
        - Add error handling for registration failures

      - Task 5: Deploy and Test Unauthenticated Access (AC: #1, #3, #5)
        - Deploy updated component files to HA
        - Restart Home Assistant
        - Test from laptop browser (logged out of HA)
        - Test from mobile phone browser (no HA app login)
        - Test from tablet or second device
        - Verify no authentication prompt appears
        - Verify page loads successfully on all devices
        - Test concurrent access from multiple devices

      - Task 6: Validation and Documentation (AC: #4, #5)
        - Verify HA logs show view registration message
        - Confirm no errors or warnings in HA logs
        - Monitor HA UI responsiveness during testing
        - Document exact URL pattern used
        - Document HTTP view implementation pattern
        - Capture successful test results (screenshots optional)
        - Note any limitations or edge cases discovered
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Unauthenticated Access</title>
      <description>Given Beatsy component is loaded in HA, When I navigate to `http://&lt;HA_IP&gt;:8123/api/beatsy/test.html` from any device on local network, Then the page loads successfully without authentication prompt, And accessing the page does NOT require HA login credentials</description>
    </criterion>

    <criterion id="AC-2">
      <title>Page Content</title>
      <description>Given the test page loads, When I view the page content, Then the page displays "Beatsy POC - Unauthenticated Access Test", And the page renders valid HTML with proper structure</description>
    </criterion>

    <criterion id="AC-3">
      <title>Multi-Device Access</title>
      <description>Given the test page is accessible, When multiple devices access the page simultaneously, Then all devices can load and view the page concurrently, And no authentication prompt appears on any device</description>
    </criterion>

    <criterion id="AC-4">
      <title>HTTP View Registration</title>
      <description>Given Beatsy component initializes, When the HTTP view is registered, Then HA logs confirm view registration: "Test HTTP view registered at /api/beatsy/test.html", And no errors occur during registration</description>
    </criterion>

    <criterion id="AC-5">
      <title>No HA Impact</title>
      <description>Given the test page is being accessed, When multiple requests are made, Then Home Assistant remains responsive, And no performance degradation detected, And HA UI remains accessible to authenticated users</description>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation & Multi-Risk POC</title>
        <section>Story 1.2: HTTP Endpoints</section>
        <snippet>Test endpoint for unauthenticated access validation: GET /api/beatsy/test.html, Response: 200 OK (HTML page), Authentication: None required (requires_auth = False), Purpose: Validate unauthenticated HTTP access pattern</snippet>
      </doc>

      <doc>
        <path>docs/epics.md</path>
        <title>Beatsy - Epic Breakdown</title>
        <section>Story 1.2: Serve Static HTML Without Authentication</section>
        <snippet>Research `homeassistant.components.http.HomeAssistantView` for public routes. Investigate `@require_auth(False)` decorator or `CORS_ALLOWED_ORIGINS`. Alternative: Use `hass.http.register_static_path()` with public flag. Create `/www/` folder in component with `test.html`. CRITICAL TEST: Verify access from phone without HA app/login.</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Pattern 1: Unauthenticated WebSocket in HA Ecosystem - Static File Serving</section>
        <snippet>Files in custom_components/beatsy/www/ automatically served at: http://192.168.0.191:8123/local/beatsy/admin.html and http://192.168.0.191:8123/local/beatsy/start.html. Standard HA pattern for serving static files from custom components.</snippet>
      </doc>

      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture</title>
        <section>Integration Points - Static File Serving</section>
        <snippet>Use `hass.http.register_static_path()` for HTML/CSS/JS files. Standard HA pattern: Files in www/ directory automatically served at /local/beatsy/</snippet>
      </doc>

      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>NFR-S1: Local Network Only</section>
        <snippet>Beatsy operates exclusively on the local network where Home Assistant is installed. Zero internet dependencies for gameplay. Players must be on the same WiFi network as the HA instance.</snippet>
      </doc>
    </docs>

    <code>
      <file>
        <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
        <kind>integration_setup</kind>
        <symbol>async_setup</symbol>
        <lines>16-31</lines>
        <reason>Component initialization function where HTTP view registration will be added. Already initializes hass.data[DOMAIN] and includes logging pattern.</reason>
      </file>

      <file>
        <path>home-assistant-config/custom_components/beatsy/const.py</path>
        <kind>constants</kind>
        <symbol>DOMAIN</symbol>
        <lines>1-3</lines>
        <reason>Domain constant ("beatsy") required for HTTP view registration and data storage.</reason>
      </file>

      <file>
        <path>home-assistant-config/custom_components/beatsy/manifest.json</path>
        <kind>manifest</kind>
        <symbol>dependencies</symbol>
        <lines>6</lines>
        <reason>Manifest already includes "http" dependency required for HTTP view registration.</reason>
      </file>
    </code>

    <dependencies>
      <python>
        <package name="homeassistant" version="2024.1+" />
        <package name="aiohttp" version="bundled-with-ha" note="HTTP server framework" />
      </python>

      <homeassistant>
        <integration name="http" version="core" required="true" />
      </homeassistant>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint type="architecture">
      <description>Use homeassistant.components.http.HomeAssistantView base class for HTTP views</description>
      <source>docs/architecture.md#Integration-Points</source>
    </constraint>

    <constraint type="architecture">
      <description>Set requires_auth = False class attribute to bypass HA authentication. 2025 Status: Pattern confirmed current and NOT deprecated - actively used in core integrations (Telegram webhook).</description>
      <source>docs/tech-spec-epic-1.md#Story-1.2, Web Research 2025-11-10</source>
    </constraint>

    <constraint type="architecture">
      <description>2025 Clarification: Standard HA pattern is files in /config/www/ served at /local/. Custom components should use HomeAssistantView for programmatic serving. This story uses HTTP view approach to validate pattern needed for Story 1.3 WebSocket endpoint.</description>
      <source>docs/architecture.md#Static-File-Serving, Web Research 2025-11-10</source>
    </constraint>

    <constraint type="alternative">
      <description>Alternative approach available: Home Assistant webhook component (/api/webhook/{webhook_id}) provides unauthenticated endpoints by design. Consider if HTTP view pattern fails.</description>
      <source>Web Research 2025-11-10</source>
    </constraint>

    <constraint type="security">
      <description>POC security relaxation acceptable for local network testing only. Not production-ready.</description>
      <source>docs/tech-spec-epic-1.md#Security</source>
    </constraint>

    <constraint type="implementation">
      <description>Use module-level _LOGGER = logging.getLogger(__name__) pattern for logging</description>
      <source>home-assistant-config/custom_components/beatsy/__init__.py</source>
    </constraint>

    <constraint type="implementation">
      <description>Follow async/await patterns consistently throughout component</description>
      <source>home-assistant-config/custom_components/beatsy/__init__.py</source>
    </constraint>

    <constraint type="implementation">
      <description>Register HTTP view in async_setup() after hass.data[DOMAIN] initialization</description>
      <source>docs/stories/1-2-serve-static-html-without-authentication.md#Dev-Notes</source>
    </constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>HomeAssistantView</name>
      <kind>base_class</kind>
      <signature>
        class BeatsyTestView(HomeAssistantView):
            url = "/api/beatsy/test.html"
            name = "api:beatsy:test"
            requires_auth = False

            async def get(self, request):
                # Serve test.html
      </signature>
      <path>homeassistant.components.http.HomeAssistantView</path>
      <notes>Base class for custom HTTP views in Home Assistant. Setting requires_auth = False bypasses authentication requirement.</notes>
    </interface>

    <interface>
      <name>hass.http.register_view</name>
      <kind>api_method</kind>
      <signature>hass.http.register_view(view_instance)</signature>
      <path>homeassistant.core.HomeAssistant</path>
      <notes>Register custom HTTP view with Home Assistant HTTP component. Call in async_setup().</notes>
    </interface>

    <interface>
      <name>hass.data[DOMAIN]</name>
      <kind>data_storage</kind>
      <signature>hass.data[DOMAIN] = {}</signature>
      <path>home-assistant-config/custom_components/beatsy/__init__.py</path>
      <notes>Component data storage initialized in Story 1.1. Available for HTTP view to store state if needed.</notes>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual integration testing for POC phase (Epic 1). Test from multiple devices without HA authentication to verify public access pattern. Automated testing deferred to Epic 10 (Production Readiness). Focus on functional validation: page accessibility, multi-device access, no authentication prompts, HA stability.
    </standards>

    <locations>
      - home-assistant-config/custom_components/beatsy/ (component code)
      - /config/home-assistant.log (HA logs for verification)
      - Manual testing: Browser access from laptop, phone, tablet
    </locations>

    <ideas>
      <test ac="AC-1" description="Access test.html from laptop browser while logged out of HA - verify no auth prompt">
        Verify URL http://&lt;HA_IP&gt;:8123/api/beatsy/test.html loads without 401/403 error
      </test>

      <test ac="AC-2" description="Verify page content displays correct heading and valid HTML structure">
        Check for "Beatsy POC - Unauthenticated Access Test" heading, valid DOCTYPE, proper HTML structure
      </test>

      <test ac="AC-3" description="Open test.html on 3 devices simultaneously - verify all load concurrently">
        Test from laptop, phone, tablet at same time - all should load successfully
      </test>

      <test ac="AC-4" description="Check HA logs for view registration confirmation message">
        Verify log entry: "Test HTTP view registered at /api/beatsy/test.html" appears after HA restart
      </test>

      <test ac="AC-5" description="Monitor HA responsiveness during multiple test page accesses">
        Access page repeatedly, verify HA UI remains responsive, no errors in logs, normal CPU/memory usage
      </test>
    </ideas>
  </tests>
</story-context>
