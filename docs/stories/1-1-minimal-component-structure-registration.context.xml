<story-context id="bmad/bmm/workflows/4-implementation/story-context/template" v="1.0">
  <metadata>
    <epicId>1</epicId>
    <storyId>1.1</storyId>
    <title>Minimal Component Structure &amp; Registration</title>
    <status>drafted</status>
    <generatedAt>2025-11-10</generatedAt>
    <generator>BMAD Story Context Workflow</generator>
    <sourceStoryPath>docs/stories/1-1-minimal-component-structure-registration.md</sourceStoryPath>
  </metadata>

  <story>
    <asA>Home Assistant administrator</asA>
    <iWant>a minimal Beatsy custom component that loads successfully in HA</iWant>
    <soThat>I can begin testing core architectural assumptions</soThat>
    <tasks>
      <task id="1" ac="#3">
        <name>Create Component Directory Structure</name>
        <subtasks>
          <subtask>Create `custom_components/beatsy/` directory in HA config</subtask>
          <subtask>Verify directory permissions and ownership</subtask>
        </subtasks>
      </task>
      <task id="2" ac="#2">
        <name>Create manifest.json</name>
        <subtasks>
          <subtask>Create `manifest.json` with 2025-compliant fields</subtask>
          <subtask>Include domain: "beatsy"</subtask>
          <subtask>Include version: "0.1.0-poc" (required for custom components)</subtask>
          <subtask>Include dependencies: ["http", "spotify"]</subtask>
          <subtask>Include iot_class: "local_push"</subtask>
          <subtask>Include codeowners: ["@markusholzhaeuser"]</subtask>
          <subtask>Validate JSON syntax</subtask>
        </subtasks>
      </task>
      <task id="3" ac="#3">
        <name>Create const.py</name>
        <subtasks>
          <subtask>Create `const.py` file</subtask>
          <subtask>Define DOMAIN constant: `DOMAIN = "beatsy"`</subtask>
          <subtask>Add module docstring</subtask>
        </subtasks>
      </task>
      <task id="4" ac="#1,#3">
        <name>Create __init__.py with async_setup</name>
        <subtasks>
          <subtask>Create `__init__.py` file</subtask>
          <subtask>Import necessary HA modules (homeassistant.core, logging)</subtask>
          <subtask>Import DOMAIN from const.py</subtask>
          <subtask>Implement `async_setup(hass, config)` function</subtask>
          <subtask>Initialize `hass.data[DOMAIN]` with empty dict</subtask>
          <subtask>Add INFO log: "Beatsy custom component loaded (POC)"</subtask>
          <subtask>Return True from async_setup</subtask>
          <subtask>Add module docstring and type hints</subtask>
        </subtasks>
      </task>
      <task id="5" ac="#1,#4,#5">
        <name>Deploy and Test Component Loading</name>
        <subtasks>
          <subtask>Copy component files to HA config directory</subtask>
          <subtask>Restart Home Assistant</subtask>
          <subtask>Check HA logs for "Beatsy custom component loaded (POC)" message</subtask>
          <subtask>Verify no errors or warnings in logs</subtask>
          <subtask>Check HA integrations registry for Beatsy entry</subtask>
          <subtask>Verify HA UI remains responsive after loading</subtask>
          <subtask>Monitor system resources (no performance degradation)</subtask>
        </subtasks>
      </task>
      <task id="6" ac="#4,#5">
        <name>Validation and Documentation</name>
        <subtasks>
          <subtask>Verify component appears in HA integrations list</subtask>
          <subtask>Document exact HA version tested</subtask>
          <subtask>Document component load time from logs</subtask>
          <subtask>Capture log output showing successful load</subtask>
          <subtask>Note any warnings or observations for Epic 2</subtask>
        </subtasks>
      </task>
      <task id="7">
        <name>Update Story 2.7 for 2025 Config Flow Patterns</name>
        <subtasks>
          <subtask>After Story 1.1 completion, update epics.md Story 2.7</subtask>
          <subtask>Incorporate modern `async_setup_entry()` pattern</subtask>
          <subtask>Document config entry vs legacy YAML approach</subtask>
          <subtask>Note that config flow is now preferred in 2025</subtask>
        </subtasks>
      </task>
    </tasks>
  </story>

  <acceptanceCriteria>
    <criterion id="AC-1">
      <title>Component Registration</title>
      <given>Home Assistant Core 2024.1+ is running</given>
      <when>Beatsy component files are placed in `custom_components/beatsy/`</when>
      <then>HA recognizes the component at startup without errors</then>
      <and>Component appears in HA logs as "Beatsy custom component loaded (POC)"</and>
    </criterion>
    <criterion id="AC-2">
      <title>Manifest Compliance (2025 Standards)</title>
      <given>`manifest.json` exists in component directory</given>
      <when>HA validates the manifest</when>
      <then>Manifest includes all required 2025 fields: domain, name, version, documentation, dependencies, codeowners, iot_class, requirements</then>
    </criterion>
    <criterion id="AC-3">
      <title>Component Structure</title>
      <given>Component directory exists</given>
      <when>HA loads the component</when>
      <then>Files are present and valid: __init__.py with async_setup, manifest.json with valid JSON, const.py with DOMAIN constant</then>
    </criterion>
    <criterion id="AC-4">
      <title>Integration Registry</title>
      <given>Component loaded successfully</given>
      <when>Checking HA integrations registry</when>
      <then>Beatsy appears as registered integration</then>
      <and>No errors or warnings in HA logs</and>
    </criterion>
    <criterion id="AC-5">
      <title>No Performance Impact</title>
      <given>Component is loaded</given>
      <when>HA is running normally</when>
      <then>No HA crashes occur, no performance degradation detected, HA UI remains responsive</then>
    </criterion>
  </acceptanceCriteria>

  <artifacts>
    <docs>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Multi-Risk POC</title>
        <section>Services and Modules - Story 1.1</section>
        <snippet>Story 1.1 creates minimal component structure with __init__.py (Component registration and setup), manifest.json (HA metadata with domain, version, dependencies), and const.py (DOMAIN constant). Establishes Python 3.11+ component using Home Assistant 2024.x patterns and validates component registration and lifecycle.</snippet>
      </doc>
      <doc>
        <path>docs/tech-spec-epic-1.md</path>
        <title>Epic Technical Specification: Foundation &amp; Multi-Risk POC</title>
        <section>Acceptance Criteria - AC-1</section>
        <snippet>Beatsy component loads in HA without errors, appears in HA integrations registry, no HA crashes or performance degradation during/after loading. Verified via HA logs and HA UI integrations page.</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Project Initialization</title>
        <section>First Implementation Story</section>
        <snippet>Initialize Beatsy integration structure from ludeeus/integration_blueprint. Create custom_components/beatsy/ with __init__.py (integration initialization), manifest.json (HA metadata, dependencies), const.py (constants), hacs.json (HACS metadata), and README.md. This establishes HACS-compatible structure, standard HA integration patterns, and Python 3.11+ compatibility (HA 2024.x requirement).</snippet>
      </doc>
      <doc>
        <path>docs/architecture.md</path>
        <title>Architecture - Project Structure</title>
        <section>Component Files</section>
        <snippet>Component structure follows HA integration blueprint: custom_components/beatsy/ contains __init__.py (integration setup), manifest.json (HA metadata: domain, dependencies, version), const.py (constants including DOMAIN), and config_flow.py (optional HA UI config, may skip for MVP).</snippet>
      </doc>
      <doc>
        <path>docs/epics.md</path>
        <title>Beatsy - Epic Breakdown</title>
        <section>Epic 1: Story 1.1</section>
        <snippet>Minimal viable component structure only. No configuration, no entities, no services yet. Focus: Does HA accept our component structure? Validate manifest.json schema compliance. Test: Restart HA, check logs, confirm no errors.</snippet>
      </doc>
      <doc>
        <path>docs/PRD.md</path>
        <title>Product Requirements Document</title>
        <section>FR-1: Home Assistant Integration</section>
        <snippet>Must be installable as custom component via HACS. Integrates with existing HA Spotify configuration. Uses HA's data registry for game state storage. Requires Python 3.11+, Home Assistant Core 2024.1+.</snippet>
      </doc>
    </docs>
    <code>
      <artifact>
        <path>home-assistant-config/</path>
        <kind>directory</kind>
        <symbol>config root</symbol>
        <reason>Deployment target: Component files must be copied to /config/custom_components/beatsy/</reason>
      </artifact>
    </code>
    <dependencies>
      <python>
        <package name="homeassistant" version="2024.1+" />
        <package name="aiohttp" note="bundled with HA" />
        <package name="logging" note="stdlib" />
      </python>
    </dependencies>
  </artifacts>

  <constraints>
    <constraint>Component must follow Home Assistant integration blueprint structure (ludeeus/integration_blueprint)</constraint>
    <constraint>Python 3.11+ required for Home Assistant 2024.x compatibility</constraint>
    <constraint>Manifest.json must include 2025 required fields: version (mandatory for custom components), iot_class, codeowners</constraint>
    <constraint>Component must use async/await patterns (async_setup function)</constraint>
    <constraint>Component must not crash or degrade HA performance (NFR-R1: Component Stability)</constraint>
    <constraint>Component load time must be under 5 seconds (NFR performance target)</constraint>
    <constraint>Use hass.data[DOMAIN] pattern for state storage (not hass.helpers.storage for POC)</constraint>
    <constraint>No YAML configuration needed - all setup via web UI in later epics</constraint>
    <constraint>This is POC validation only - production quality deferred to Epic 2</constraint>
  </constraints>

  <interfaces>
    <interface>
      <name>async_setup(hass, config)</name>
      <kind>function signature</kind>
      <signature>async def async_setup(hass: HomeAssistant, config: dict) -&gt; bool</signature>
      <path>custom_components/beatsy/__init__.py</path>
      <description>HA integration entry point. Called during HA startup to register component. Must return True on success.</description>
    </interface>
    <interface>
      <name>hass.data[DOMAIN]</name>
      <kind>state storage</kind>
      <signature>hass.data[DOMAIN] = {}</signature>
      <description>In-memory state storage pattern for HA integrations. Initialize with empty dict during setup.</description>
    </interface>
    <interface>
      <name>manifest.json</name>
      <kind>configuration file</kind>
      <signature>{"domain": "beatsy", "name": "Beatsy", "version": "0.1.0-poc", "dependencies": ["http", "spotify"], "codeowners": ["@markusholzhaeuser"], "iot_class": "local_push", "requirements": []}</signature>
      <path>custom_components/beatsy/manifest.json</path>
      <description>Home Assistant integration metadata. Defines domain, dependencies, and component properties.</description>
    </interface>
  </interfaces>

  <tests>
    <standards>
      Manual integration testing for POC validation. Deploy component to HA config directory, restart HA, verify logs show "Beatsy custom component loaded (POC)" message, check HA integrations registry for component entry, monitor system resources for performance impact. Test framework: pytest for later epics, manual verification for Story 1.1.
    </standards>
    <locations>
      <location>tests/</location>
      <location>custom_components/beatsy/ (inline test comments)</location>
    </locations>
    <ideas>
      <idea ac="AC-1">Test: Deploy component files to /config/custom_components/beatsy/, restart HA, verify log message "Beatsy custom component loaded (POC)" appears without errors</idea>
      <idea ac="AC-2">Test: Validate manifest.json against HA 2025 schema requirements, verify all required fields present (domain, name, version, dependencies, codeowners, iot_class)</idea>
      <idea ac="AC-3">Test: Verify __init__.py contains async_setup function, const.py defines DOMAIN constant, manifest.json is valid JSON</idea>
      <idea ac="AC-4">Test: Navigate to Settings → Devices &amp; Services → Integrations in HA UI, verify Beatsy appears in list, check HA logs for zero errors/warnings</idea>
      <idea ac="AC-5">Test: Monitor HA startup time (should remain under 30 seconds total, component adds &lt;5s), verify HA UI remains responsive after load, check system resources show no memory leak or CPU spike</idea>
    </ideas>
  </tests>
</story-context>
